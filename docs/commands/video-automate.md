# /video-automate Command

The `/video-automate` command generates AppleScript automation files that control iTerm2 to execute terminal commands with proper timing for screen recording.

## Overview

This command transforms your beat sheet into executable automation scripts that drive the terminal during recording. It synchronizes command execution with your narration timing.

**Command**: `/video-automate <topic>`

**Allowed Tools**: `Read`, `Write`

## What It Does

1. **Reads Beat Sheet**
   - Parses the beat-by-beat script
   - Extracts terminal commands
   - Notes timing for each beat

2. **Generates AppleScript**
   - Creates iTerm2 automation
   - Adds delays matching narration duration
   - Includes command execution with proper timing

3. **Creates Recording Script**
   - Bash wrapper for screen recording workflow
   - Pre-recording checklist
   - Recording instructions

## Usage

```bash
/video-automate installation-and-setup
```

**Parameters**:
- `<topic>`: The topic name (must have existing beat sheet)

**Prerequisites**:
- Beat sheet must exist at `scripts/video-scripts/[topic]-beat-sheet.md`
- iTerm2 must be installed (macOS only)

## Generated Files

### 1. Recording Wrapper Script (NEW!)
**Location**: `scripts/automation/[topic]-record.sh`

**Purpose**: Orchestrates automated screen recording with perfect A/V sync

This is the **main script you run** to record your video. It:
- Starts FFmpeg screen recording automatically
- Runs the AppleScript automation
- Stops recording when complete
- Ensures perfect sync between video and audio

**No manual recording needed!** The script handles everything.

### 2. AppleScript File
**Location**: `scripts/automation/[topic]-automate.scpt`

**Purpose**: Automates iTerm2 to execute commands with timing (called by recording wrapper)

**Example**:
```applescript
#!/usr/bin/osascript
-- Automation script for: installation-and-setup
-- Generated by Training Video Generator

tell application "iTerm2"
    -- Create new window with default profile
    create window with default profile

    tell current session of current window
        -- Beat 1: Introduction
        -- Duration: 15 seconds
        delay 15

        -- Beat 2: Check Prerequisites
        -- Duration: 25 seconds
        write text "node --version"
        delay 3
        write text "npm --version"
        delay 3

        -- Beat 3: Create Project Directory
        -- Duration: 20 seconds
        write text "cd ~/Projects"
        delay 2
        write text "mkdir my-project"
        delay 1
        write text "cd my-project"
        delay 3

        -- Continue with remaining beats...
    end tell
end tell

-- Display completion message
display notification "Video recording automation complete!" with title "Training Video Generator"
```

### 3. Timing JSON
**Location**: `scripts/automation/[topic]-timing.json`

**Purpose**: Machine-readable timing data for merging video and audio

**Example**:
```json
{
  "video_title": "installation-and-setup",
  "total_duration": "5 minutes",
  "beats": [
    {
      "number": 1,
      "name": "Introduction",
      "duration": 15,
      "has_commands": false
    },
    {
      "number": 2,
      "name": "Check Prerequisites",
      "duration": 25,
      "has_commands": true,
      "commands": ["node --version", "npm --version"]
    }
  ]
}
```

### 4. Command Reference
**Location**: `scripts/automation/[topic]-commands.sh`

**Purpose**: Human-readable command reference for manual review

## Recording Workflow (UPDATED!)

### New: Fully Automated Recording

**Simply run ONE command:**

```bash
bash scripts/automation/[topic]-record.sh
```

This wrapper script:
1. Shows pre-recording checklist
2. Asks you to confirm ready
3. **Starts FFmpeg screen recording automatically**
4. Gives you 3-second countdown to position windows
5. **Runs AppleScript automation**
6. **Stops recording automatically when done**
7. Saves to `recordings/[topic].mov`

**Perfect A/V sync guaranteed!** No manual timing needed.

### Step-by-Step

#### 1. Prepare Environment

```bash
# Clean terminal
clear

# Set up test environment (if needed)
cd ~/test-recordings

# Position windows for recording
# Close distracting applications
# Increase terminal font size (18-24pt recommended)
```

#### 2. Run Recording Wrapper

```bash
bash scripts/automation/[topic]-record.sh
```

#### 3. Follow Prompts

```
üé¨ Training Video Recording Script
Topic: installation-and-setup
Duration: 5 minutes

üìã Pre-recording checklist:
  ‚úì Clean terminal environment
  ‚úì Hide personal information
  ‚úì Close unnecessary applications
  ‚úì Position terminal window for recording

Ready to start automated recording? (y/n) y

üöÄ Starting automated recording in 3 seconds...
   (Position your windows now!)
   3...
   2...
   1...

üìπ Starting screen recording...
‚úì Recording started (PID: 12345)

ü§ñ Running automation script...
[Commands execute automatically with proper timing]
‚úì Automation complete!

‚èπÔ∏è  Stopping screen recording...
‚úÖ Recording complete!

üìä Video Information:
  File: recordings/installation-and-setup.mov
  Size: 45MB
  Duration: 5m 12s
```

#### 4. Review Recording

```bash
open recordings/[topic].mov
```

### Manual Recording (Advanced)

If you need manual control, you can still run the AppleScript directly:

```bash
# 1. Start screen recording manually
# Press Cmd+Shift+5, select area, click Record

# 2. Run automation
osascript scripts/automation/[topic]-automate.scpt

# 3. Stop recording manually
# Click stop button in macOS menu bar
```

**Note**: Manual recording may cause sync issues with audio!

## Timing and Synchronization

### Perfect A/V Sync

The recording wrapper ensures perfect synchronization:

1. **Recording starts** ‚Üí FFmpeg begins capturing
2. **Buffer added** ‚Üí 2 seconds for recording to stabilize
3. **Automation runs** ‚Üí Commands execute with beat timing
4. **Buffer added** ‚Üí 1 second before stopping
5. **Recording stops** ‚Üí FFmpeg finalizes video

**Video duration = Audio duration** (when merged with `/video-merge`)

### Delay Calculation

The AppleScript adds delays based on beat sheet:
- **Narration duration**: Time for TTS audio
- **Command execution**: Time for output to appear
- **User comprehension**: Time to read output

**Example**:
```applescript
-- Beat 1 narration is 15 seconds
delay 15

-- Beat 2: Command execution
write text "npm install"
delay 3  -- Time for command to complete

-- Beat 3: Show results
write text "npm start"
delay 20  -- Time for narration + output
```

### Adjusting Timing

If automation feels off:

1. **Re-generate beat sheet** with adjusted durations
2. **Run `/video-automate` again** to regenerate scripts
3. **Test with short recordings** before full takes

Don't manually edit the `.scpt` file - regenerate from updated beat sheet!

## Configuration

### FFmpeg Recording Settings

Customize in the generated `[topic]-record.sh` script:

```bash
# FFmpeg screen recording settings
FRAME_RATE="30"           # FPS (30 recommended)
VIDEO_QUALITY="18"        # CRF (18 = high quality, 23 = standard)
PRESET="ultrafast"        # Encoding speed during recording
DISPLAY_ID="1"            # Display to record (1 = primary)
```

### Screen Recording Permissions

Grant FFmpeg permission to record screen:

1. **System Settings** ‚Üí **Privacy & Security** ‚Üí **Screen Recording**
2. Add **Terminal** or **iTerm2** to allowed apps
3. Restart terminal after granting permission

## Platform Support

### macOS (Recommended)
- ‚úÖ Full support with iTerm2
- ‚úÖ AppleScript automation
- ‚úÖ Built-in screen recording (Cmd+Shift+5)

### Linux
- ‚ö†Ô∏è Partial support
- Requires manual terminal scripting
- Use `xdotool` or custom expect scripts
- Screen recording with OBS Studio or SimpleScreenRecorder

### Windows
- ‚ö†Ô∏è Partial support
- Requires PowerShell or AutoHotkey scripts
- Screen recording with built-in Game Bar or OBS Studio

## Tips

1. **Test First**: Run automation without recording to check timing
2. **Clean Environment**: Start with fresh terminal, no history
3. **Font Size**: Increase terminal font for better readability (18-24pt)
4. **Window Size**: Use consistent terminal dimensions
5. **Practice**: Do a few test runs before final recording

## Troubleshooting

### "iTerm2 not found"

**Problem**: AppleScript can't find iTerm2

**Solution**:
```bash
# Check iTerm2 is installed
ls /Applications/iTerm.app

# If not installed
brew install --cask iterm2
```

### "Automation runs too fast"

**Problem**: Commands execute before narration finishes

**Solution**:
- Increase delay values in `.scpt` file
- Add buffer time between beats
- Review beat sheet timing

### "Commands fail during automation"

**Problem**: Commands error out or don't execute

**Solution**:
- Verify commands work manually
- Check working directory is correct
- Ensure prerequisites are met
- Add error handling in script

### "Permission denied"

**Problem**: macOS security blocks automation

**Solution**:
1. Open **System Preferences** ‚Üí **Security & Privacy**
2. Go to **Privacy** tab ‚Üí **Automation**
3. Enable **iTerm2** to control **System Events**

### "Screen recording stops unexpectedly"

**Problem**: FFmpeg stops recording during automation

**Solution**:
- Grant screen recording permission to Terminal/iTerm2
- System Settings ‚Üí Privacy & Security ‚Üí Screen Recording
- Enable Terminal or iTerm2
- Restart terminal application

### "FFmpeg not found"

**Problem**: Recording wrapper can't find FFmpeg

**Solution**:
```bash
# Install FFmpeg via Homebrew
brew install ffmpeg

# Verify installation
ffmpeg -version
```

### "Video and audio out of sync"

**Problem**: After merging, video and audio don't align

**Solution**:
- **Don't use manual recording!** Use the automated wrapper script
- The wrapper script ensures perfect sync by controlling both recording start/stop
- If using manual recording, sync issues are unavoidable

## Advanced Usage

### Custom Commands Between Beats

Edit the generated `.scpt` file to add custom behavior:

```applescript
-- Clear screen before next beat
write text "clear"
delay 1

-- Show directory contents with highlighting
write text "ls -la"
delay 4

-- Custom notification
display notification "Starting main installation" with title "Recording"
```

### Conditional Logic

Add conditional execution:

```applescript
-- Check if directory exists before creating
write text "[ -d my-project ] || mkdir my-project"
delay 2
```

### Multi-Window Recording

Control multiple terminal windows:

```applescript
tell application "iTerm2"
    -- Window 1: Server
    tell first window
        tell current session
            write text "npm run dev"
        end tell
    end tell

    -- Window 2: Client commands
    tell second window
        tell current session
            delay 5
            write text "npm run client"
        end tell
    end tell
end tell
```

## Next Steps

After generating automation scripts:

1. **Review** the generated `.scpt` file
2. **Test** automation without recording
3. **Adjust** timing if needed
4. **Record** the video with automation
5. **Save** recording as `recordings/[topic].mov`
6. **Run** `/video-narrate` to generate audio
7. **Run** `/video-merge` to combine video and audio

## Related Commands

- [`/video-script`](video-script.md) - Generate beat sheet (prerequisite)
- [`/video-narrate`](video-narrate.md) - Generate TTS narration
- [`/video-merge`](video-merge.md) - Merge video and audio
- [Workflow Guide](../guides/workflow.md) - Complete production workflow
