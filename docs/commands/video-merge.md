# /video-merge Command

The `/video-merge` command combines your screen recording with the generated TTS narration to produce the final training video.

## Overview

This is the final step in the video production workflow. The command uses FFmpeg to merge your screen recording (video) with the TTS-generated narration (audio) into a single, optimized MP4 file.

**Command**: `/video-merge <topic>`

**Allowed Tools**: `Read`, `Write`, `Bash`

## What It Does

1. **Verifies Input Files**
   - Checks for screen recording at `recordings/[topic].mov`
   - Checks for narration audio at `audio/[topic]/narration.mp3`

2. **Merges Video and Audio**
   - Combines video and audio tracks
   - Encodes to H.264 video codec
   - Encodes to AAC audio codec
   - Optimizes for web playback

3. **Generates Final Video**
   - Creates optimized MP4 at `output/[topic]-final.mp4`
   - Adds metadata
   - Provides video statistics

## Usage

```bash
/video-merge installation-and-setup
```

**Parameters**:
- `<topic>`: The topic name

**Prerequisites**:
- Screen recording: `recordings/[topic].mov` or `.mp4`
- Narration audio: `audio/[topic]/narration.mp3`
- FFmpeg installed

## Input Files

### Video Recording
**Location**: `recordings/[topic].mov`

**Recording Methods**:
- macOS: Cmd+Shift+5 screen recording
- OBS Studio: Record → Save as MOV or MP4
- QuickTime: File → New Screen Recording

**Requirements**:
- Format: MOV, MP4, or any FFmpeg-compatible format
- Resolution: Any (1920x1080 or 1280x720 recommended)
- Framerate: 30fps or 60fps

### Audio Narration
**Location**: `audio/[topic]/narration.mp3`

**Generated by**: `/video-narrate` command

**Format**: MP3, 192kbps, mono

## Output File

**Location**: `output/[topic]-final.mp4`

**Specifications**:
- **Video Codec**: H.264 (libx264)
- **Video Quality**: CRF 22 (high quality)
- **Video Preset**: slow (best compression)
- **Audio Codec**: AAC
- **Audio Bitrate**: 192 kbps
- **Format**: MP4 with web-optimized flags

**Typical File Sizes** (5-minute video):
- 1920x1080: ~150-250 MB
- 1280x720: ~80-150 MB

## Generated Files

### Merge Script
**Location**: `scripts/automation/[topic]-merge.sh`

Example script:
```bash
#!/bin/bash
set -e

# Configuration
TOPIC="installation-and-setup"
VIDEO_INPUT="recordings/${TOPIC}.mov"
AUDIO_INPUT="audio/${TOPIC}/narration.mp3"
OUTPUT="output/${TOPIC}-final.mp4"

# FFmpeg settings
VIDEO_CODEC="libx264"
VIDEO_CRF="22"
VIDEO_PRESET="slow"
AUDIO_CODEC="aac"
AUDIO_BITRATE="192k"

# Ensure output directory exists
mkdir -p "output"

echo "🎬 Merging Video and Audio"
echo "Video: $VIDEO_INPUT"
echo "Audio: $AUDIO_INPUT"
echo "Output: $OUTPUT"

# Merge video and audio
ffmpeg -i "$VIDEO_INPUT" -i "$AUDIO_INPUT" \
       -c:v "$VIDEO_CODEC" -preset "$VIDEO_PRESET" -crf "$VIDEO_CRF" \
       -c:a "$AUDIO_CODEC" -b:a "$AUDIO_BITRATE" \
       -movflags +faststart \
       "$OUTPUT" -y

echo "✅ Merge complete!"
echo "💾 Output: $OUTPUT"
```

### Final Video
**Location**: `output/[topic]-final.mp4`

Ready to upload to:
- YouTube
- Vimeo
- LMS platforms
- Company portals
- Social media

## FFmpeg Settings Explained

### Video Codec (H.264)
```bash
-c:v libx264
```
Industry-standard codec, compatible with all platforms

### CRF (Constant Rate Factor)
```bash
-crf 22
```
Quality setting:
- **18**: Near lossless (very large files)
- **22**: High quality (recommended)
- **26**: Good quality (smaller files)
- **30**: Acceptable quality (small files)

### Preset
```bash
-preset slow
```
Encoding speed vs compression:
- **ultrafast**: Fastest, largest files
- **fast**: Quick encoding, larger files
- **medium**: Balanced (default)
- **slow**: Better compression (recommended)
- **veryslow**: Best compression, slow encoding

### Audio Codec (AAC)
```bash
-c:a aac -b:a 192k
```
Standard audio codec, 192kbps is high quality for voice

### Web Optimization
```bash
-movflags +faststart
```
Moves metadata to file beginning for faster web streaming

## Configuration

Customize merge settings in `.training-video-generator/config.json`:

```json
{
  "video": {
    "codec": "libx264",
    "crf": 22,
    "preset": "slow",
    "resolution": "1920x1080",
    "framerate": 30
  },
  "audio": {
    "codec": "aac",
    "bitrate": "192k",
    "sampleRate": 44100
  },
  "output": {
    "format": "mp4",
    "faststart": true
  }
}
```

## Example Output

```
🎬 Merging Video and Audio
Topic: installation-and-setup
Video: recordings/installation-and-setup.mov
Audio: audio/installation-and-setup/narration.mp3
Output: output/installation-and-setup-final.mp4

⏳ Processing with FFmpeg...
[ffmpeg output showing progress]

✅ Merge complete!

📊 Video Information:
Duration: 298.5s | Size: 187MB

💾 Output: output/installation-and-setup-final.mp4
🎉 Your training video is ready!
```

## Advanced Options

### Custom Resolution

Resize video during merge:

```bash
ffmpeg -i "$VIDEO_INPUT" -i "$AUDIO_INPUT" \
       -vf "scale=1280:720" \
       -c:v libx264 -preset slow -crf 22 \
       -c:a aac -b:a 192k \
       -movflags +faststart \
       "$OUTPUT" -y
```

### Add Watermark

Overlay text or image:

```bash
# Text watermark
ffmpeg -i "$VIDEO_INPUT" -i "$AUDIO_INPUT" \
       -vf "drawtext=text='MyCompany':x=10:y=10:fontsize=24:fontcolor=white" \
       -c:v libx264 -preset slow -crf 22 \
       -c:a aac -b:a 192k \
       "$OUTPUT" -y

# Image watermark
ffmpeg -i "$VIDEO_INPUT" -i "$AUDIO_INPUT" -i logo.png \
       -filter_complex "[0:v][2:v]overlay=10:10" \
       -c:v libx264 -preset slow -crf 22 \
       -c:a aac -b:a 192k \
       "$OUTPUT" -y
```

### Trim Video

Cut to specific time range:

```bash
ffmpeg -i "$VIDEO_INPUT" -i "$AUDIO_INPUT" \
       -ss 00:00:05 -to 00:05:00 \
       -c:v libx264 -preset slow -crf 22 \
       -c:a aac -b:a 192k \
       "$OUTPUT" -y
```

### Add Intro/Outro

Concatenate multiple videos:

```bash
# Create concat file
cat > concat.txt << EOF
file 'intro.mp4'
file 'main-video.mp4'
file 'outro.mp4'
EOF

# Merge
ffmpeg -f concat -safe 0 -i concat.txt \
       -i "$AUDIO_INPUT" \
       -c:v libx264 -preset slow -crf 22 \
       -c:a aac -b:a 192k \
       "$OUTPUT" -y
```

### Adjust Audio Volume

If narration is too quiet/loud:

```bash
ffmpeg -i "$VIDEO_INPUT" -i "$AUDIO_INPUT" \
       -filter:a "volume=1.5" \
       -c:v libx264 -preset slow -crf 22 \
       -c:a aac -b:a 192k \
       "$OUTPUT" -y
```

Volume values:
- `0.5`: 50% volume (quieter)
- `1.0`: Original volume
- `1.5`: 150% volume (louder)
- `2.0`: 200% volume (much louder)

### Fade In/Out

Add video/audio fades:

```bash
ffmpeg -i "$VIDEO_INPUT" -i "$AUDIO_INPUT" \
       -vf "fade=t=in:st=0:d=1,fade=t=out:st=297:d=1" \
       -af "afade=t=in:st=0:d=1,afade=t=out:st=297:d=1" \
       -c:v libx264 -preset slow -crf 22 \
       -c:a aac -b:a 192k \
       "$OUTPUT" -y
```

## Troubleshooting

### "Video file not found"

**Problem**: Recording file missing

**Solution**:
```bash
# Verify file exists
ls -lh recordings/[topic].mov

# Check for different extensions
ls -lh recordings/[topic].*

# Move file if named differently
mv recordings/my-video.mov recordings/[topic].mov
```

### "Audio file not found"

**Problem**: Narration file missing

**Solution**:
```bash
# Verify file exists
ls -lh audio/[topic]/narration.mp3

# Re-run narration generation if needed
/video-narrate [topic]
```

### "FFmpeg not installed"

**Problem**: FFmpeg command not found

**Solution**:
```bash
# macOS
brew install ffmpeg

# Linux (Ubuntu/Debian)
sudo apt-get install ffmpeg

# Linux (Fedora)
sudo dnf install ffmpeg

# Windows
# Download from https://ffmpeg.org/download.html
```

### "Audio/video out of sync"

**Problem**: Audio doesn't match video timing

**Solution**:
1. **Check beat sheet timing** - Verify narration duration matches beats
2. **Re-record video** with corrected automation timing
3. **Adjust audio delay** if slight offset:
   ```bash
   ffmpeg -i "$VIDEO_INPUT" -itsoffset 1.5 -i "$AUDIO_INPUT" \
          -c:v libx264 -preset slow -crf 22 \
          -c:a aac -b:a 192k \
          "$OUTPUT" -y
   ```

### "Output file too large"

**Problem**: Final video is too big

**Solution**:
- **Increase CRF**: Change from 22 to 26 or 28
- **Use faster preset**: Change from "slow" to "medium"
- **Reduce resolution**: Scale down from 1080p to 720p
- **Lower framerate**: 30fps instead of 60fps

### "Encoding very slow"

**Problem**: FFmpeg takes too long

**Solution**:
- **Use faster preset**: Change "slow" to "medium" or "fast"
- **Hardware acceleration**: Use `-hwaccel auto` flag
- **Lower resolution**: Process at 720p instead of 1080p

### "No audio in output"

**Problem**: Final video has no sound

**Solution**:
```bash
# Check input audio has sound
ffplay audio/[topic]/narration.mp3

# Verify audio stream in output
ffprobe output/[topic]-final.mp4

# Force audio stream copy
ffmpeg -i "$VIDEO_INPUT" -i "$AUDIO_INPUT" \
       -c:v libx264 -preset slow -crf 22 \
       -c:a copy \
       "$OUTPUT" -y
```

## Quality Control

### Check Video Information

```bash
ffprobe -v quiet -print_format json -show_format -show_streams \
        output/[topic]-final.mp4 | jq
```

### Play Video

```bash
# macOS
open output/[topic]-final.mp4

# Linux
vlc output/[topic]-final.mp4

# FFmpeg player
ffplay output/[topic]-final.mp4
```

### Check File Size

```bash
ls -lh output/[topic]-final.mp4
du -h output/[topic]-final.mp4
```

### Verify Compatibility

Upload to:
- YouTube (test as unlisted)
- Vimeo (test as private)
- MediaInfo tool for technical analysis

## Upload Guidelines

### YouTube
- **Format**: MP4 (H.264 + AAC) ✅
- **Max file size**: 256 GB
- **Max duration**: 12 hours
- **Recommended resolution**: 1920x1080
- **Recommended framerate**: 30fps

### Vimeo
- **Format**: MP4 (H.264 + AAC) ✅
- **Free account**: 500MB per week
- **Recommended resolution**: 1920x1080
- **Recommended bitrate**: 5-10 Mbps

### LMS Platforms
- **Canvas, Moodle, Blackboard**: MP4 (H.264 + AAC) ✅
- **Typical max size**: 500MB - 2GB
- **Recommended resolution**: 1280x720 or 1920x1080

## Next Steps

After merging:

1. **Review** the final video for quality
2. **Add captions** (optional but recommended)
3. **Upload** to your platform
4. **Share** with your audience
5. **Gather feedback** for future videos

## Related Commands

- [`/video-topics`](video-topics.md) - Discover video topics
- [`/video-script`](video-script.md) - Generate beat sheet
- [`/video-automate`](video-automate.md) - Create automation scripts
- [`/video-narrate`](video-narrate.md) - Generate TTS narration
- [Workflow Guide](../guides/workflow.md) - Complete production workflow
